# RiDCTL Agent Notes — 2025-08-14

## Summary
- Implemented M1 (Status Cards & Environment Banner).
- Added TUI helpers to print header and colorized status lines.
- Extended status aggregation to surface Role, VirtualizationOk, ISO/Share/Sync placeholders.
- Updated menu to use the new banner and cards.
- Enhanced virtualization readiness checks and detailed reporting; fixed menu exit behavior.
- Added ISO helper automation with Fido, including optional non-interactive mode that captures URL and downloads ISO automatically.
- Wired host menu for end-to-end VM creation (ISO helper + confirm before apply). Implemented vmcli fresh create.
- Implemented shared folder guest verification and surfaced status in TUI.
- Added inline VMX path hints in menu prompts.

## Why
Provide immediate UX feedback in the CLI/TUI, enabling quick host/guest awareness and environment readiness visibility; foundational for later flows.

## Changes
- `src/Private/Ui.Tui.ps1`: Implemented `Write-RiDHeader`, `Write-RiDStatusCards` and helpers.
- `src/Private/Status.Aggregate.ps1`: Added `Role`, `VirtualizationOk`, `VirtualizationConflicted`, conflict names, and `SyncStatus`; preserved existing fields.
- `src/Public/Show-RiDMenu.ps1`: Switched to TUI helpers for banner and status rendering; X now exits the menu.
- `src/Public/Test-RiDVirtualization.ps1`: Added Overall/Conflicts/Info sections, one-line next steps, and extra signals (Sandbox, Device Guard/VBS, hypervisor present). Treats WSL as informational.
- `src/Private/System.Virtualization.ps1`: Surfaced `WindowsSandboxPresent`, `DeviceGuardVBSConfigured/Running`, and `HypervisorPresent`.
- `docs/USAGE.md`: Documented virtualization readiness checks, exit codes, and next steps.
- `docs/CHECKLIST.md`: Marked M1 complete.
 - M3: Implemented Fido-based ISO helper integration (wrapper + automated path wiring) and documented setup.
- ISO UX improvements:
    - `src/Private/Iso.Fetch.ps1`: New `Install-RiDFido` to fetch Fido and persist path in config.
    - `src/Private/Iso.Fido.ps1`: `Invoke-RiDFidoDownload` with `-TryNonInteractive` using Fido `-Win/-Rel/-Ed/-Lang/-Arch/-GetUrl`; auto-downloads ISO.
    - `src/Public/Open-RiDIsoHelper.ps1`: Automated path prompts for non-interactive and optional Release/Edition/Arch; persists overrides to config.
    - `src/Private/Ui.Dialogs.ps1`: `Show-RiDOpenFileDialog` now supports `-InitialDirectory`/`-Title`.
    - `docs/USAGE.md`: Added ISO Helper section incl. non-interactive defaults and config overrides.

## Commands Executed
- Reviewed repo structure and key files.
- (No runtime validation here due to non-Windows environment.)

## Blockers / Next Steps
- Runtime verification requires Windows PowerShell.
- Next: M4 (vmrun clone + VMX edits, robust error handling) and M6 (shared folder verify from guest).

## M4 Work
- `src/Private/Vm.Vmrun.ps1`:
  - Enhanced `Invoke-RiDVmrun` with `-CaptureOutput` and `-AlwaysRun` to support read-only queries while still honoring dry-run for destructive ops.
  - Added `Get-RiDVmrunSnapshots` to list/parse snapshots; used for pre-validation.
  - Upgraded `Clone-RiDVmrunTemplate` to validate template path, ensure destination directory, prevent overwrite, validate snapshot existence, and surface vmrun errors; returns destination VMX path.
- `docs/CHECKLIST.md`: Marked M4 complete.
- M5: Implemented vmcli create wrapper + New-RiDVmCliVM; auto method prefers vmcli.
- M10: Updated host menu to guide full flow with confirmation; guest menu already scoped appropriately.
- M6: Added `Test-RiDSharedFolder` (public) using vmrun runProgramInGuest; menu offers verification prompt after repair; status aggregator checks guest UNC path and host path presence.
- VMX path guidance: added validation helper and docs on .vmx path format (no need to escape backslashes; quote spaces; examples). Updated Start/Stop/Checkpoint/Repair to validate early and print help.
- Menu prompts now include inline VMX path hint: e.g., `C:\VMs\MyVM\MyVM.vmx`.

## Checklist Status Today
- Pre-flight: Repo sanity [x], Config defaults [x]
- M1: Status cards/banner [x]
- M2: Virtualization readiness polish [x]
- M3: ISO helper automated (Fido + non-interactive option) [x]
- M4: vmrun clone with snapshot validation [x]
- M5: vmcli fresh create [x]
- M6: Shared folder configure & verify (host + guest) [x]
- M10: Menu wiring for full flows [x]
- Remaining: M7 (guest configure), M8 (sync), M9 (utilities polish), M11 (config prompts), M12 (tests & CI), M13 (docs)

Notes: `New-RiDVM` already applies VMX edits post-clone (CPU/Mem and optional ISO), so M4’s second bullet is satisfied.

## Quick Commands (today)
- Import module: `Import-Module ./src -Force`
- Install Fido: `Install-RiDFido -PersistConfig -Apply`
- ISO helper (automated, non-interactive): `Open-RiDIsoHelper` → Automated → Try non-interactive = Y.
